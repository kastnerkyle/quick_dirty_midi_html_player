<// minimalized version of a much nicer webpage from https://github.com/ct-martin/web-midi-player>
<// https://github.com/mudcube/MIDI.js/pull/211>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
<script src="js/inc/shim/Base64.js" type="text/javascript"></script>
<script src="js/inc/shim/Base64binary.js" type="text/javascript"></script>
<script src="js/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
<script src="js/inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
<script src="js/inc/jasmid/stream.js"></script>
<script src="js/inc/jasmid/midifile.js"></script>
<script src="js/inc/jasmid/replayer.js"></script>
<script src="js/midi/audioDetect.js" type="text/javascript"></script>
<script src="js/midi/gm.js" type="text/javascript"></script>
<script src="js/midi/loader.js" type="text/javascript"></script>
<script src="js/midi/plugin.audiotag.js" type="text/javascript"></script>
<script src="js/midi/plugin.webaudio.js" type="text/javascript"></script>
<script src="js/midi/plugin.webmidi.js" type="text/javascript"></script>
<script src="js/midi/player.js" type="text/javascript"></script>
<script src="js/midi/synesthesia.js" type="text/javascript"></script>
<script src="js/util/dom_request_xhr.js" type="text/javascript"></script>
<script src="js/util/dom_request_script.js" type="text/javascript"></script>

<script>
var playState = "init";
var songs = {};
var currentSong = "";

// File Uploading
function handleFileSelect(evt) {
    var files = evt.target.files;
    for (var i = 0, f; f = files[i]; i++) {
        if (!(f.type.match('audio/midi') || f.type.match('audio/mid'))) {
            console.log("Invalid: " + f.type);
            alert("Only MIDI files are allowed");
            continue;
        }
        var reader = new FileReader();
        reader.onload = (function(theFile) {
            return function(e) {
                if(songs[escape(theFile.name)]) return;
                songs[escape(theFile.name)] = e.target.result;
                $("#playlist-list").append("<div class=\"playlist-list-item\" onclick=\"playSong('" + escape(theFile.name) + "')\"><span class=\"fa-play-circle\"></span> " + escape(theFile.name) + "</div>");
            };
        })(f);
        reader.readAsDataURL(f);
    }
}

// Start a new song
function playSong(name) {
    MIDI.loadPlugin({
        soundfontUrl: "https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/",
		instrument: "acoustic_grand_piano",
        onsuccess: function() {
            for(var i = 0; i < 16; i++) {
                if(i != 9)
                    MIDI.programChange(i, 0);
            };
        }
    });
	var startingPoint = MIDI.getContext().currentTime;

	var vol1 = document.getElementById('slider1').value;
	var vol2 = document.getElementById('slider2').value;
	var vol3 = document.getElementById('slider3').value;
	var vol4 = document.getElementById('slider4').value;
    
	MIDI.setVolume(0, vol1, 0);
	MIDI.setVolume(1, vol2, 0);
	MIDI.setVolume(2, vol3, 0);
	MIDI.setVolume(3, vol4, 0);

    MIDI.Player.loadFile(songs[name], function() { currentSong = name; changeState("start") });
}

// Some stuff for cleaner play/pause
function changeState(state) {
    if(state == playState) {
        return;
    } else if(state == "start") {
        playState = "play";

        // this is a way to set the channel number
        // this is also a way to set the program number
		for(var e = 0; e < MIDI.Player.data.length; e++)
		{
			var currentEvent = MIDI.Player.data[e][0].event;
									
			//if(currentEvent.subtype == "programChange") currentEvent.programNumber = 0;
			//currentEvent.channel = 0;
		}

		function clone(o) {
			if (typeof o != 'object') return (o);
			if (o == null) return (o);
			var ret = (typeof o.length == 'number') ? [] : {};
			for (var key in o) ret[key] = clone(o[key]);
			return ret;
		};
					
		MIDI.Player.replayer.getData = function() { return clone(MIDI.Player.data); }

        MIDI.Player.start();

        $("#play-btn").hide();
        $("#pause-btn").show();
    } else if(state == "end") {
        playState = "stop";
        $("#play-btn").show();
        $("#pause-btn").hide();
    } else if(state == "play") {
        if(playState == "pause") {
            MIDI.Player.resume();
        } else {
            if(currentSong == "") {
                alert("Please select a song from the playlist");
                return;
            } else {
                playSong(currentSong);
            }
        }
        playState = "play";
        $("#play-btn").hide();
        $("#pause-btn").show();
    } else if(state == "pause") {
        playState = "pause";
        MIDI.Player.pause();
        $("#play-btn").show();
        $("#pause-btn").hide();
    }
}

// Start JS things when page ready
$(document).ready( function() {
    document.getElementById('files').addEventListener('change', handleFileSelect, false);
	document.getElementById('slider1').value = 80;
	document.getElementById('slider2').value = 80;
	document.getElementById('slider3').value = 80;
	document.getElementById('slider4').value = 80;

    // set to piano by default
    MIDI.loadPlugin({
        soundfontUrl: "https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/",
		instrument: "acoustic_grand_piano",
        onsuccess: function() {
            for(var i = 0; i < 16; i++) {
                if(i != 9)
                    MIDI.programChange(i, 0);
            };
            var vol1 = document.getElementById('slider1').value;
            var vol2 = document.getElementById('slider2').value;
            var vol3 = document.getElementById('slider3').value;
            var vol4 = document.getElementById('slider4').value;
            MIDI.setVolume(0, vol1, 0);
            MIDI.setVolume(1, vol2, 0);
            MIDI.setVolume(2, vol3, 0);
            MIDI.setVolume(3, vol4, 0);
        }
    });
});

function sliderChange1(val) {
    document.getElementById('output1').innerHTML = val;
}
function sliderChange2(val) {
    document.getElementById('output2').innerHTML = val;
}
function sliderChange3(val) {
    document.getElementById('output3').innerHTML = val;
}
function sliderChange4(val) {
    document.getElementById('output4').innerHTML = val;
}
</script>

<div id="controls">
    <div id="control-buttons">
        <span id="play-btn" onclick="changeState('play')"></span>
        <span id="pause-btn" onclick="changeState('pause')"></span>
       <input id="slider1" type="range" min="0" max="120" step="1" oninput="sliderChange1(this.value)">
<output id="output1"></output>
       <input id="slider2" type="range" min="0" max="120" step="1" oninput="sliderChange2(this.value)">
<output id="output2"></output>
       <input id="slider3" type="range" min="0" max="120" step="1" oninput="sliderChange3(this.value)">
<output id="output3"></output>
       <input id="slider4" type="range" min="0" max="120" step="1" oninput="sliderChange4(this.value)">
<output id="output4"></output>
       <p>Controls (SATB order) are not dynamic - re-click the song name to restart play with the new volume, parts, etc</p>
    </div>
</div>
<script>
</script>
<div id="playlist" class="panel">
    <div class="container">
        <input type="file" id="files" name="files" multiple />
        <div id="playlist-list">
            <p id="playlist-list-empty"><i>Click the filename in the list (once loaded) to start playing</i></p>
        </div>
    </div>
</div>
